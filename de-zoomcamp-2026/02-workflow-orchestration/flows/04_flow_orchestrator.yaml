id: 04_flow_orchestrator
namespace: zoomcamp

tasks:
# 1. Cycle to backfill entire 2020 (24 runs)
  - id: backfill_2020
    type: io.kestra.plugin.core.flow.ForEach
    values: ["green", "yellow"]
    tasks:
      - id: months_2020
        type: io.kestra.plugin.core.flow.ForEach
        values: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"]
        tasks:
          - id: subflow_2020
            type: io.kestra.plugin.core.flow.Subflow
            namespace: zoomcamp
            flowId: 03_gcp_taxi
            inputs:
              taxi: "{{ parent.taskrun.value }}"
              year: "2020"
              month: "{{ taskrun.value }}"
            wait: true # Wait for one month's run to finish before starting the next
            transmitFailed: true # If the subflow fails, stop this execution as well

# 2. Cycle to backfill entire 2021 (14 runs)
  - id: backfill_2021
    type: io.kestra.plugin.core.flow.ForEach
    values: ["green", "yellow"]
    tasks:
      - id: months_2021
        type: io.kestra.plugin.core.flow.ForEach
        values: ["01", "02", "03", "04", "05", "06", "07"]
        tasks:
          - id: subflow_2021
            type: io.kestra.plugin.core.flow.Subflow
            namespace: zoomcamp
            flowId: 03_gcp_taxi
            inputs:
              taxi: "{{ parent.taskrun.value }}"
              year: "2021"
              month: "{{ taskrun.value }}"
            wait: true # Wait for one month's run to finish before starting the next
            transmitFailed: true # If the subflow fails, stop this execution as well


